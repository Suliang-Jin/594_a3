<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Humor Rating Task</title>
  <script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
  <style>
    body {
      font-family: "Helvetica", sans-serif;
      background-color: #fafafa;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    .section {
      margin-top: 25px;
    }
    .headline {
      padding: 15px;
      background: #f3f3f3;
      border-radius: 8px;
    }
    .rating {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      font-size: 18px;
      cursor: pointer;
    }
    .rating input {
        display: none;
    }
    .rating label {
        transition: all 0.3s ease;
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
        cursor: pointer;
        width: 180px;
        height: 30px;
        text-align: center;
        align-items: center;
        justify-content: center;
        display: flex;
    }
    .rating label:hover {
        background-color: #e9e9e9;
        border-color: #999;
    }
    .rating input:checked + label {
        background-color: #4CAF50;
        border-color: #4CAF50;
        color: white;
    }
    .rating input:checked + label:hover {
        background-color: #45a049;
    }
    .reasoning {
      margin-top: 10px;
      width: 100%;
    }
    .submit {
      text-align: center;
      margin-top: 30px;
    }

    .dropdown {
        display: block;
        margin: 0 auto;
        padding: 10px 15px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
        cursor: pointer;
        min-width: 150px;
    }

    .dropdown:hover {
        border-color: #999;
        background-color: #e9e9e9;
    }

    .dropdown:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 style="text-align: center;">üì∞ Humor Rating Task</h1>

    <crowd-form answer-format="flatten-objects">
      <!-- Introduction -->
      <div class="section" style="font-size: 18px; border: 2px solid transparent; padding: 15px; margin: 5px 0; border-radius: 8px; background-color: #f0f0f0;">
          <h3>Instruction</h3>
          <p>Welcome to humor rating task! üéâ</p>
          <p>In this task, you will see an <em>original news headline</em> and an <em>edited version with one word replaced</em>. Your goal is to rate how funny the edited version is (less funny üëé, mediocre üòê or funny üëç). Then, please tell us how much you understand the context of the headline. Optionally, you can provide a reasoning on your humor rating. </p>
          <p>*Note: the headlines are from real news reports and probably contain political contents. Also, the headlines and the edited versions are directly obtained from a CS publication dataset <em>SemEval-2020 Task 7</em>. </p>
          <h3>Example</h3>
          <p><strong>Original headline:</strong> WHO calls for <span style="color: blue;">elimination</span> of trans fat by 2023</p>
          <p><strong>Edited headline:</strong> WHO calls for <span style="color: blue;">monetization</span> of trans fat by 2023</p>
          <p>As you see, the replaced word is elimination ‚Üí monetization. You can rate the edited headline with [less funny üëé], [mediocre üòê] or [funny üëç].</p>
      </div>

      <!-- Task display -->
      <div class="section">
        <p><strong>Original headline:</strong></p>
        <div class="headline" id="orig-headline">
          Loading headline...
        </div>

        <p style="margin-top:15px;"><strong>Edited headline:</strong></p>
        <div class="headline" id="edited-headline">
          Loading edited headline...
        </div>
      </div>

      <!-- Rating section -->
      <div class="section">
        <p><strong>How funny is the edited headline?</strong></p>
        <div class="rating">
          <input type="radio" id="low" name="humor_rating" value="less_funny" required>
          <label for="low" title="Less funny">Less Funny üëé</label>

          <input type="radio" id="medium" name="humor_rating" value="mediocre">
          <label for="medium" title="Mediocre">Mediocre üòê</label>

          <input type="radio" id="high" name="humor_rating" value="funny">
          <label for="high" title="Funny">Funny üëç</label>
        </div>
      </div>

      <div class="section">
        <p><strong>At a scale of 0 to 3, how much do you think you understand the context of the headline?</strong></p>
        <select id="scale_rating" name="scale_rating" class="dropdown" required>
          <option value="" disabled selected hidden>Select a value</option>
          <option value="0">0 (I don't understand)</option>
          <option value="1">1 (I understand a little)</option>
          <option value="2">2 (I understand most of it)</option>
          <option value="3">3 (I fully understand)</option>
        </select>
      </div>

      <!-- Optional reasoning -->
      <div class="section">
        <label for="reasoning"><strong>Optional: </strong>In one or two sentences, why did you choose the rating?</label>
        <textarea id="reasoning" name="reasoning" rows="3" class="reasoning" placeholder="Write your reasoning here (optional)..."></textarea>
      </div>

      <div class="submit">
        <crowd-button form-action="submit">Submit</crowd-button>
      </div>
    </crowd-form>
  </div>

  <!-- ‚úÖ Simple headline loader with embedded data -->
  <script>
  // Embedded headlines data
  const headlines = [
    {
      "original": "WHO calls for elimination of trans fat by 2023",
      "edited": "WHO calls for monetization of trans fat by 2023"
    },
    {
      "original": "NASA discovers new planet outside solar system",
      "edited": "NASA discovers new PR intern outside solar system"
    },
    {
      "original": "Economists predict strong growth next quarter",
      "edited": "Economists predict groan next quarter"
    },
    {
      "original": "Man wins lottery for second time this year",
      "edited": "Man wins existential crisis for second time this year"
    },
    {
      "original": "Cats take over city hall during council meeting",
      "edited": "Cats take over city mall during council meeting"
    }
  ];

  // Get worker ID (with fallback for testing)
  function getWorkerId() {
    if (typeof window.turkGetParam === 'function') {
      return window.turkGetParam('workerId') || 'unknown_worker';
    } else {
      return 'test_worker_' + Math.random().toString(36).substr(2, 9);
    }
  }

  // Check if we're in preview mode
  function isPreviewMode() {
    console.log('=== CHECKING PREVIEW MODE ===');
    
    // Method 1: Check if turkGetParam function exists
    if (typeof window.turkGetParam !== 'function') {
      console.log('turkGetParam function not available - assuming preview mode');
      return true;
    }
    
    // Method 2: Try to get worker ID
    try {
      const workerId = window.turkGetParam('workerId');
      console.log('Worker ID from turkGetParam:', workerId);
      
      // Check if worker ID is valid
      if (!workerId || workerId === '' || workerId === 'undefined' || workerId === 'null') {
        console.log('No valid worker ID found - preview mode');
        return true;
      }
      
      console.log('Valid worker ID found - not preview mode');
      return false;
    } catch (error) {
      console.log('Error getting worker ID:', error, '- assuming preview mode');
      return true;
    }
  }
  
  // Alternative preview detection method
  function isPreviewModeAlternative() {
    console.log('=== ALTERNATIVE PREVIEW CHECK ===');
    
    // Check URL for preview indicators
    const url = window.location.href;
    console.log('Current URL:', url);
    
    // Check if URL contains preview indicators
    if (url.includes('preview') || url.includes('sandbox')) {
      console.log('URL contains preview/sandbox - likely preview mode');
      return true;
    }
    
    // Check if we're in an iframe (MTurk preview is often in iframe)
    if (window !== window.top) {
      console.log('In iframe - might be preview mode');
      // But don't return true here as accepted HITs are also in iframes
    }
    
    return false;
  }

  // Get worker's seen headlines from localStorage
  function getWorkerSeenHeadlines(workerId) {
    const key = `worker_seen_headlines_${workerId}`;
    const seen = localStorage.getItem(key);
    return seen ? JSON.parse(seen) : [];
  }
  
  // Mark headline as seen for worker
  function markHeadlineAsSeen(workerId, headlineId) {
    const key = `worker_seen_headlines_${workerId}`;
    const seen = getWorkerSeenHeadlines(workerId);
    if (!seen.includes(headlineId)) {
      seen.push(headlineId);
      localStorage.setItem(key, JSON.stringify(seen));
      console.log(`Marked headline ${headlineId} as seen for worker ${workerId}`);
    }
  }
  
  // Get available headlines for worker (not seen before)
  function getAvailableHeadlines(workerId) {
    const seen = getWorkerSeenHeadlines(workerId);
    const available = [];
    
    for (let i = 0; i < headlines.length; i++) {
      if (!seen.includes(i)) {
        available.push(i);
      }
    }
    
    console.log(`Worker ${workerId} has seen headlines:`, seen);
    console.log(`Available headlines for worker:`, available);
    
    return available;
  }

  // Load and display headline
  function loadHeadline() {
    console.log('=== LOADING HEADLINE ===');
    
    const workerId = getWorkerId();
    console.log('Worker ID:', workerId);
    
    // Check if we're in preview mode using multiple methods
    const isPreview1 = isPreviewMode();
    const isPreview2 = isPreviewModeAlternative();
    const isPreview = isPreview1 || isPreview2;
    
    console.log('Is preview mode (method 1):', isPreview1);
    console.log('Is preview mode (method 2):', isPreview2);
    console.log('Final preview mode decision:', isPreview);
    
    if (isPreview) {
      // Show placeholder message in preview
      document.getElementById("orig-headline").textContent = "The headline will be loaded after you accept the HIT.";
      document.getElementById("edited-headline").textContent = "The edited headline will be loaded after you accept the HIT.";
      console.log("Preview mode: Showing placeholder message");
      return;
    }
    
    // Not in preview mode - load actual headline
    console.log('Not in preview mode - loading actual headline');
    
    // Get available headlines for this worker
    const availableHeadlines = getAvailableHeadlines(workerId);
    
    if (availableHeadlines.length === 0) {
      // Worker has seen all headlines
      document.getElementById("orig-headline").textContent = "üéâ You have completed all available headlines! Thank you for your participation.";
      document.getElementById("edited-headline").textContent = "Please submit this HIT to complete your work.";
      console.log("Worker has seen all headlines");
      return;
    }
    
    // Randomly select from available headlines
    const randomIndex = Math.floor(Math.random() * availableHeadlines.length);
    const selectedId = availableHeadlines[randomIndex];
    
    console.log('Available headlines:', availableHeadlines);
    console.log('Randomly selected headline ID:', selectedId);
    
    // Display the selected headline
    const h = headlines[selectedId];
    console.log('Selected headline:', h);
    
    document.getElementById("orig-headline").textContent = h.original;
    document.getElementById("edited-headline").textContent = h.edited;
    
    console.log('Headlines displayed successfully');
    
    // Mark this headline as seen for this worker
    markHeadlineAsSeen(workerId, selectedId);
    
    // Add hidden fields
    const headlineInput = document.createElement('input');
    headlineInput.type = 'hidden';
    headlineInput.name = 'headline_id';
    headlineInput.value = selectedId;
    document.querySelector('crowd-form').appendChild(headlineInput);
    
    const workerInput = document.createElement('input');
    workerInput.type = 'hidden';
    workerInput.name = 'worker_id';
    workerInput.value = workerId;
    document.querySelector('crowd-form').appendChild(workerInput);
    
    console.log(`‚úÖ Worker ${workerId} assigned headline ${selectedId}: ${h.original}`);
  }

  // Test function to verify random headline generation
  function testRandomHeadline() {
    console.log('=== TESTING RANDOM HEADLINE GENERATION ===');
    const selectedId = Math.floor(Math.random() * headlines.length);
    const h = headlines[selectedId];
    console.log('Random headline ID:', selectedId);
    console.log('Random headline:', h);
    return h;
  }
  
  // Helper function to clear worker's seen headlines (for testing)
  function clearWorkerHistory(workerId) {
    const key = `worker_seen_headlines_${workerId}`;
    localStorage.removeItem(key);
    console.log(`Cleared history for worker: ${workerId}`);
  }
  
  // Helper function to check worker's seen headlines
  function checkWorkerHistory(workerId) {
    const seen = getWorkerSeenHeadlines(workerId);
    console.log(`Worker ${workerId} has seen headlines:`, seen);
    return seen;
  }
  
  // Make test functions available globally
  window.testRandomHeadline = testRandomHeadline;
  window.clearWorkerHistory = clearWorkerHistory;
  window.checkWorkerHistory = checkWorkerHistory;

  // Load headline when page loads
  loadHeadline();
  </script>
</body>
</html>
