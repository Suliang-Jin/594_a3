<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Humor Rating Task</title>
  <script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
  <style>
    body {
      font-family: "Helvetica", sans-serif;
      background-color: #fafafa;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }
    .section { margin-top: 25px; }
    .headline {
      padding: 15px;
      background: #f3f3f3;
      border-radius: 8px;
    }
    .rating { display:flex; justify-content:center; gap:10px; margin-top:15px; }
    .rating input { display:none; }
    .rating label {
      transition: all 0.3s ease;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      cursor: pointer;
      width: 180px; height: 30px;
      display:flex; align-items:center; justify-content:center;
    }
    .rating label:hover { background:#e9e9e9; border-color:#999; }
    .rating input:checked + label {
      background:#4CAF50; border-color:#4CAF50; color:white;
    }
    .reasoning { margin-top:10px; width:100%; }
    .submit { text-align:center; margin-top:30px; }
    .dropdown {
      display:block; margin:0 auto; padding:10px 15px; font-size:16px;
      border:2px solid #ddd; border-radius:8px; background:#f9f9f9;
    }
  </style>
</head>

<body>
    <div class="container">
      <h1 style="text-align: center;">üì∞ Humor Rating Task</h1>
  
      <crowd-form answer-format="flatten-objects">
        <!-- Introduction -->
        <div class="section" style="font-size: 18px; border: 2px solid transparent; padding: 15px; margin: 5px 0; border-radius: 8px; background-color: #f0f0f0;">
            <h3>Instruction</h3>
            <p>Welcome to humor rating task! üéâ</p>
            <p>In this task, you will see an <em>original news headline</em> and an <em>edited version with one word replaced</em>. Your goal is to rate how funny the edited version is (less funny üëé, mediocre üòê or funny üëç). Then, please tell us how much you understand the context of the headline. Optionally, you can provide a reasoning on your humor rating. </p>
            <p>*Note: the headlines are from real news reports and probably contain political contents. Also, the headlines and the edited versions are directly obtained from a CS publication dataset <em>SemEval-2020 Task 7</em>. </p>
            <h3>Example</h3>
            <p><strong>Original headline:</strong> WHO calls for <span style="color: blue;">elimination</span> of trans fat by 2023</p>
            <p><strong>Edited headline:</strong> WHO calls for <span style="color: blue;">monetization</span> of trans fat by 2023</p>
            <p>As you see, the replaced word is elimination ‚Üí monetization. You can rate the edited headline with [less funny üëé], [mediocre üòê] or [funny üëç].</p>
        </div>
  
        <!-- Task display -->
        <div class="section">
          <p><strong>Original headline:</strong></p>
          <div class="headline" id="orig-headline">
            Loading headline...
          </div>
  
          <p style="margin-top:15px;"><strong>Edited headline:</strong></p>
          <div class="headline" id="edited-headline">
            Loading edited headline...
          </div>
        </div>
  
        <!-- Rating section -->
        <div class="section">
          <p><strong>How funny is the edited headline?</strong></p>
          <div class="rating">
            <input type="radio" id="low" name="humor_rating" value="less_funny" required>
            <label for="low" title="Less funny">Less Funny üëé</label>
  
            <input type="radio" id="medium" name="humor_rating" value="mediocre">
            <label for="medium" title="Mediocre">Mediocre üòê</label>
  
            <input type="radio" id="high" name="humor_rating" value="funny">
            <label for="high" title="Funny">Funny üëç</label>
          </div>
        </div>
  
        <div class="section">
          <p><strong>At a scale of 0 to 3, how much do you think you understand the context of the headline?</strong></p>
          <select id="scale_rating" name="scale_rating" class="dropdown" required>
            <option value="" disabled selected hidden>Select a value</option>
            <option value="0">0 (I don't understand)</option>
            <option value="1">1 (I understand a little)</option>
            <option value="2">2 (I understand most of it)</option>
            <option value="3">3 (I fully understand)</option>
          </select>
        </div>
  
        <!-- Optional reasoning -->
        <div class="section">
          <label for="reasoning"><strong>Optional: </strong>In one or two sentences, why did you choose the rating?</label>
          <textarea id="reasoning" name="reasoning" rows="3" class="reasoning" placeholder="Write your reasoning here (optional)..."></textarea>
        </div>
  
        <div class="submit">
          <crowd-button form-action="submit">Submit</crowd-button>
        </div>
      </crowd-form>
  </div>

  <script>
  // ==================== Embedded dataset ====================
  const headlines = [
    {"original": "WHO calls for elimination of <em>trans fat</em> by 2023", "edited": "WHO calls for monetization of trans fat by 2023"},
    {"original": "NASA discovers new planet outside solar <em>system</em>", "edited": "NASA discovers new PR intern outside solar system"},
    {"original": "Economists predict strong growth next quarter", "edited": "Economists predict groan next quarter"},
    {"original": "Man wins lottery for second time this year", "edited": "Man wins existential crisis for second time this year"},
    {"original": "Cats take over city hall during council meeting", "edited": "Cats take over city mall during council meeting"}
  ];

  // Utility: get MTurk param
  function getMTurkParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  // Utility: pick random integer
  function randInt(max) { return Math.floor(Math.random() * max); }

   // Main logic
   function loadHeadline() {
     const workerId = getMTurkParam('workerId');
     const headlineId = getMTurkParam('headline_id'); // Get headline ID from URL

     // PREVIEW MODE
     if (!workerId) {
       document.getElementById("orig-headline").textContent = "The headline will be generated after the HIT is accepted.";
       document.getElementById("edited-headline").textContent = "The edited headline will be generated after the HIT is accepted.";
       return;
     }

     // AFTER ACCEPTANCE
     const completionKey = `worker_completions_${workerId}`;
     let completions = JSON.parse(localStorage.getItem(completionKey) || "[]");
     
     // Check if worker has already completed 3 HITs
     if (completions.length >= 3) {
       document.getElementById("orig-headline").textContent = "üéâ Thank you! You have completed all 3 HITs available to you.";
       document.getElementById("edited-headline").textContent = "Please do not accept any more HITs from this batch.";
       
       // Hide the form
       const form = document.querySelector('crowd-form');
       if (form) form.style.display = 'none';
       return;
     }

     // Get the specific headline for this HIT
     let selectedId;
     if (headlineId && !isNaN(headlineId)) {
       selectedId = parseInt(headlineId);
       if (selectedId < 0 || selectedId >= headlines.length) {
         selectedId = randInt(headlines.length);
       }
     } else {
       selectedId = randInt(headlines.length);
     }

     // Check if worker has already seen this specific headline
     if (completions.includes(selectedId)) {
       document.getElementById("orig-headline").textContent = "You have already completed this headline. Please try a different HIT.";
       document.getElementById("edited-headline").textContent = "This headline has already been rated by you.";
       
       // Hide the form
       const form = document.querySelector('crowd-form');
       if (form) form.style.display = 'none';
       return;
     }

     // Record this completion
     completions.push(selectedId);
     localStorage.setItem(completionKey, JSON.stringify(completions));

     const h = headlines[selectedId];
     document.getElementById("orig-headline").innerHTML = h.original;
     document.getElementById("edited-headline").innerHTML = h.edited;

     // Show completion progress
     const progressDiv = document.createElement('div');
     progressDiv.style.cssText = 'background: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center;';
     progressDiv.innerHTML = `üìä Progress: ${completions.length}/3 HITs completed`;
     document.querySelector('.container').insertBefore(progressDiv, document.querySelector('crowd-form'));

     // Hidden fields for export
     const form = document.querySelector('crowd-form');
     const hid1 = document.createElement('input');
     hid1.type = 'hidden';
     hid1.name = 'worker_id';
     hid1.value = workerId;
     form.appendChild(hid1);

     const hid2 = document.createElement('input');
     hid2.type = 'hidden';
     hid2.name = 'headline_id';
     hid2.value = selectedId;
     form.appendChild(hid2);

     const hid3 = document.createElement('input');
     hid3.type = 'hidden';
     hid3.name = 'completion_count';
     hid3.value = completions.length;
     form.appendChild(hid3);
   }

  window.onload = loadHeadline;
  </script>
</body>
</html>
